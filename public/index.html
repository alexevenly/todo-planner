<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Minimalistic Calendar</title>
    <link rel="stylesheet" type="text/css" href="style.css" id="main-style">
    <link rel="stylesheet" type="text/css" href="style-modern.css" id="modern-style" disabled>
	<link rel="icon" href="favicon.ico" type="image/x-icon">
  	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <script src="calendar-modal.js"></script>
  </head>
  <body>
    <div class="theme-toggle-container">
      <label class="theme-toggle">
        <input type="checkbox" id="theme-toggle-checkbox">
        <span class="slider">
          <span class="slider-text classic">Classic</span>
          <span class="slider-text modern">Modern</span>
        </span>
      </label>
    </div>
    
    <div class="calendar-container">
      <div id="calendar">
        <div class="calendar-header">
          <button id="prev-btn" class="nav-btn">‹</button>
          <h2 id="month-year"></h2>
          <button id="next-btn" class="nav-btn">›</button>
          <div class="header-buttons">
            <button id="today-btn" class="today-btn">Today</button>
            <button id="logout-btn" class="logout-btn">Logout</button>
          </div>
        </div>
        <div class="calendar-grid">
          <div class="weekdays">
            <div class="weekday">Пн</div>
            <div class="weekday">Вт</div>
            <div class="weekday">Ср</div>
            <div class="weekday">Чт</div>
            <div class="weekday">Пт</div>
            <div class="weekday">Сб</div>
            <div class="weekday">Вс</div>
          </div>
          <div class="days-grid" id="days-grid">
            <!-- Days will be generated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
    
    <script>
		let availableDates = [];
		let currentDate = new Date();
		let today = new Date();

		// Russian month names
		const monthNames = [
			'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
			'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
		];

		document.addEventListener('DOMContentLoaded', function() {
			// Load available dates and initialize calendar
			loadAvailableDates().then(() => {
				renderCalendar();
			});
			
			// Event listeners
			document.getElementById('prev-btn').addEventListener('click', () => {
				currentDate.setMonth(currentDate.getMonth() - 1);
				renderCalendar();
			});
			
			document.getElementById('next-btn').addEventListener('click', () => {
				currentDate.setMonth(currentDate.getMonth() + 1);
				renderCalendar();
			});
			
			document.getElementById('today-btn').addEventListener('click', () => {
				currentDate = new Date();
				renderCalendar();
			});
			
			document.getElementById('logout-btn').addEventListener('click', async () => {
				try {
					const response = await fetch('/auth/logout', {
						method: 'POST',
						credentials: 'include'
					});
					
					if (response.ok) {
						window.location.href = '/login.html';
					} else {
						alert('Logout failed. Please try again.');
					}
				} catch (error) {
					console.error('Logout error:', error);
					alert('Logout failed. Please try again.');
				}
			});
			
			// Theme toggle functionality
			const themeToggle = document.getElementById('theme-toggle-checkbox');
			const mainStyle = document.getElementById('main-style');
			const modernStyle = document.getElementById('modern-style');
			
			// Load saved theme preference
			const savedTheme = localStorage.getItem('theme') || 'classic';
			if (savedTheme === 'modern') {
				themeToggle.checked = true;
				mainStyle.disabled = true;
				modernStyle.disabled = false;
			}
			
			themeToggle.addEventListener('change', function() {
				if (this.checked) {
					// Switch to modern theme
					mainStyle.disabled = true;
					modernStyle.disabled = false;
					localStorage.setItem('theme', 'modern');
				} else {
					// Switch to classic theme
					mainStyle.disabled = false;
					modernStyle.disabled = true;
					localStorage.setItem('theme', 'classic');
				}
			});
		});

		async function loadAvailableDates() {
			try {
				const response = await fetch('/dates');
				if (response.status === 401) {
					// Redirect to login if unauthorized
					window.location.href = '/login.html';
					return;
				}
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				availableDates = await response.json();
			} catch (error) {
				console.error('Error loading dates:', error);
				availableDates = [];
			}
		}


		function renderCalendar() {
			// Update month/year display
			document.getElementById('month-year').textContent = 
				`${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
			
			// Get first day of month and number of days
			const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
			const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
			const daysInMonth = lastDay.getDate();
			
			// Get first day of week (Monday = 1, Sunday = 0, adjust for Monday start)
			let startDay = firstDay.getDay();
			startDay = startDay === 0 ? 6 : startDay - 1; // Convert Sunday=0 to Sunday=6, Monday=1 to Monday=0
			
			// Clear existing days
			const daysGrid = document.getElementById('days-grid');
			daysGrid.innerHTML = '';
			
			// Add empty cells for days before month starts
			for (let i = 0; i < startDay; i++) {
				const emptyDay = document.createElement('div');
				emptyDay.className = 'day empty';
				daysGrid.appendChild(emptyDay);
			}
			
			// Add days of the month
			for (let day = 1; day <= daysInMonth; day++) {
				const dayElement = document.createElement('div');
				dayElement.className = 'day';
				dayElement.textContent = day;
				
				// Create date string in YYYY-MM-DD format
				const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
				dayElement.setAttribute('data-date', dateStr);
				
				// Check if this is today
				const isToday = (
					currentDate.getFullYear() === today.getFullYear() &&
					currentDate.getMonth() === today.getMonth() &&
					day === today.getDate()
				);
				
				if (isToday) {
					dayElement.classList.add('today');
				}
				
				// Check if date has data
				const hasData = availableDates.includes(dateStr);
				if (hasData) {
					dayElement.classList.add('has-data');
				} else {
					dayElement.classList.add('no-data');
				}
				
				// Add click handler
				dayElement.addEventListener('click', () => {
					const dateObject = new Date(dateStr);
					const dayOfWeek = dateObject.toLocaleString('ru', { weekday: 'long' });
					const isNew = !hasData;
					window.location.href = `template.html?date=${dateStr}&dayOfWeek=${dayOfWeek}&new=${isNew}`;
				});
				
				daysGrid.appendChild(dayElement);
			}
		}
	</script>
  </body>
</html>
