<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Minimalistic Calendar</title>
    <link rel="stylesheet" type="text/css" href="style.css" id="main-style">
    <link rel="stylesheet" type="text/css" href="style-modern.css" id="modern-style" disabled>
	<link rel="icon" href="favicon.ico" type="image/x-icon">
  	<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  </head>
  <body>
    <div class="theme-toggle-container">
      <label class="theme-toggle">
        <input type="checkbox" id="theme-toggle-checkbox">
        <span class="slider">
          <span class="slider-text classic">Classic</span>
          <span class="slider-text modern">Modern</span>
        </span>
      </label>
    </div>
    
    <div class="calendar-container">
      <div id="calendar"></div>
    </div>
    
    <!-- FullCalendar library -->
    <script src="index.global.min.js" type="text/javascript"></script>
    <script>
		let timeoutId;
		let availableDates = [];
		let calendar; // Store calendar instance globally

		document.addEventListener('DOMContentLoaded', function() {
			const calendarEl = document.getElementById('calendar');
			calendar = new FullCalendar.Calendar(calendarEl, {
				firstDay: 1,
				locale: 'ru',
				initialView: 'dayGridMonth',
				fixedWeekCount: false, // Prevent extra weeks
				showNonCurrentDates: true,
				// Add custom header with logout button
				headerToolbar: {
					left: 'prev,next today',
					center: 'title',
					right: 'logoutButton'
				},
				customButtons: {
					logoutButton: {
						text: 'Logout',
						click: async function() {
							try {
								const response = await fetch('/auth/logout', {
									method: 'POST',
									credentials: 'include'
								});
								
								if (response.ok) {
									window.location.href = '/login.html';
								} else {
									alert('Logout failed. Please try again.');
								}
							} catch (error) {
								console.error('Logout error:', error);
								alert('Logout failed. Please try again.');
							}
						}
					}
				},
				// Add fallback for navigation buttons
				buttonText: {
					prev: '‹',
					next: '›',
					today: 'Today'
				},
				// Handle view changes properly - only run once per view change
				datesSet: function() {
					// Clear any existing timeout to prevent multiple calls
					if (timeoutId) {
						clearTimeout(timeoutId);
					}
					// Wait for DOM to update, then run our styling once
					timeoutId = setTimeout(() => {
						// Clear any existing data-listener-added attributes to allow fresh setup
						const existingTds = document.querySelectorAll('td[data-listener-added]');
						existingTds.forEach(td => td.removeAttribute('data-listener-added'));
						
						runLoop();
						addButtonFallbacks();
						styleLogoutButton();
					}, 150);
				}
			});
			calendar.render();
			
			// Load available dates once
			loadAvailableDates().then(() => {
				runLoop();
			});
			
			// Theme toggle functionality
			const themeToggle = document.getElementById('theme-toggle-checkbox');
			const mainStyle = document.getElementById('main-style');
			const modernStyle = document.getElementById('modern-style');
			
			// Load saved theme preference
			const savedTheme = localStorage.getItem('theme') || 'classic';
			if (savedTheme === 'modern') {
				themeToggle.checked = true;
				mainStyle.disabled = true;
				modernStyle.disabled = false;
			}
			
			themeToggle.addEventListener('change', function() {
				if (this.checked) {
					// Switch to modern theme
					mainStyle.disabled = true;
					modernStyle.disabled = false;
					localStorage.setItem('theme', 'modern');
				} else {
					// Switch to classic theme
					mainStyle.disabled = false;
					modernStyle.disabled = true;
					localStorage.setItem('theme', 'classic');
				}
				
				// Don't re-render calendar, just refresh the styling
				setTimeout(() => {
					runLoop();
					addButtonFallbacks();
					styleLogoutButton();
				}, 100);
			});
		});

		async function loadAvailableDates() {
			try {
				const response = await fetch('/dates');
				if (response.status === 401) {
					// Redirect to login if unauthorized
					window.location.href = '/login.html';
					return;
				}
				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}
				availableDates = await response.json();
			} catch (error) {
				console.error('Error loading dates:', error);
				availableDates = [];
			}
		}

		function runLoop() {
			const tbody = document.querySelector('tbody[role="presentation"]');
			if (!tbody) return;
			
			// Ensure availableDates is an array
			if (!Array.isArray(availableDates)) {
				availableDates = [];
			}
			
			// Get only current month days (not fc-day-other)
			const tds = tbody.querySelectorAll('td:not(.fc-day-other)');
			tds.forEach(dayEl => {
				// Don't clone and replace - just update existing elements
				if (dayEl.classList.contains('fc-day-today')) {
					dayEl.style.border = 'solid 2px yellow';
				}
				
				const date = dayEl.getAttribute('data-date');
				let isNew = true;
				
				// Remove any existing click listeners by cloning only if needed
				if (!dayEl.hasAttribute('data-listener-added')) {
					const newDayEl = dayEl.cloneNode(true);
					dayEl.parentNode.replaceChild(newDayEl, dayEl);
					
					if (availableDates.includes(date)) {
						newDayEl.style.backgroundColor = 'lightgreen';
						isNew = false;
					} else {
						newDayEl.style.backgroundColor = '#C0C0C0'; // gray
					}
					
					newDayEl.addEventListener('click', function() {
						const dateObject = new Date(date);
						const dayOfWeek = dateObject.toLocaleString('default', { weekday: 'long' });
						window.location.href = 'template.html?date=' + date + '&dayOfWeek=' + dayOfWeek + '&new=' + isNew;
					});
					
					// Mark as having listener to prevent future cloning
					newDayEl.setAttribute('data-listener-added', 'true');
				} else {
					// Just update colors for existing elements
					if (availableDates.includes(date)) {
						dayEl.style.backgroundColor = 'lightgreen';
					} else {
						dayEl.style.backgroundColor = '#C0C0C0'; // gray
					}
				}
			});
			
			// Handle other month days
			const tdsNot = tbody.querySelectorAll('td.fc-day-other');
			tdsNot.forEach(dayEl => {
				dayEl.style.removeProperty("background-color");
			});
		}

		function addButtonFallbacks() {
			// Check if navigation symbols are properly rendered, if not use fallbacks
			const prevButton = document.querySelector('.fc-prev-button');
			const nextButton = document.querySelector('.fc-next-button');
			
			if (prevButton) {
				const prevText = prevButton.textContent.trim();
				if (prevText === '‹' || prevText === '' || prevText.length === 0) {
					// Check if the symbol is actually visible by measuring width
					const testSpan = document.createElement('span');
					testSpan.style.visibility = 'hidden';
					testSpan.style.position = 'absolute';
					testSpan.textContent = '‹';
					document.body.appendChild(testSpan);
					const symbolWidth = testSpan.offsetWidth;
					document.body.removeChild(testSpan);
					
					if (symbolWidth < 5) { // Symbol not properly rendered
						prevButton.textContent = '<';
					}
				}
			}
			
			if (nextButton) {
				const nextText = nextButton.textContent.trim();
				if (nextText === '›' || nextText === '' || nextText.length === 0) {
					const testSpan = document.createElement('span');
					testSpan.style.visibility = 'hidden';
					testSpan.style.position = 'absolute';
					testSpan.textContent = '›';
					document.body.appendChild(testSpan);
					const symbolWidth = testSpan.offsetWidth;
					document.body.removeChild(testSpan);
					
					if (symbolWidth < 5) { // Symbol not properly rendered
						nextButton.textContent = '>';
					}
				}
			}
		}

		function styleLogoutButton() {
			const logoutButton = document.querySelector('.fc-logoutButton-button');
			if (logoutButton) {
				logoutButton.classList.add('logout-button');
			}
		}
	</script>
  </body>
</html>
